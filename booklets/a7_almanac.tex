\documentclass[10pt,twoside]{book}
\usepackage{config/bind}
\usepackage{config/booklet}
\setcounter{bookLevel}{2}
\externalReferent{core}
\externalReferent{stories}
\externalReferent{judgement}
\newcounter{almatrack}
\setcounter{almatrack}{6}
\setcounter{segNo}{-22}

% Does the day have an encounter?  If so, mark it with the '\A' symbol for
% 'animal' (encounter).  The macro rolls 6 + temperature against 2D6, and
% success brings the encounter.
% 
% We want at least 6 encounters, so each failure increases the counter 'segNo'. 
% This counter starts at -22, and if it ever goes above 0 then it gets added to
% the 'roll'.
\newcommand\noteEncounter{%
  \randomize%
  \randomize%
  \randomize%
  \setcounter{enc}{6}%
  \addtocounter{enc}{\thetemperature}%
  \ifnum\thesegNo>0%
    \addtocounter{enc}{\thesegNo}%
    \ifnum\thesegNo>4%
      \addtocounter{segNo}{-5}%
    \fi%
  \fi%
  \ifnum\theenc>\value{r12}%
    \stepcounter{rn1t2}%
    \A~\showInterval{\value{rn1t2}}%
  \else%
    \stepcounter{segNo}%
  \fi%
  \lightDots%
}

\newcommand*\wrath{%
  \randomize%
  \ifcase\value{r4}\relax\or%
    \composeWrath{hurricane}
  \or%
    \composeWrath{earthquake}
  \or%
    \composeWrath{flood}
  \else%
    \ifcase\thetemperature%
      \composeWrath{snow}
    \or%
      \composeWrath{landslide}
    \else%
      \composeWrath{heatwave}
    \fi%
  \fi%
  \par%
}

\newcommand\composeWrath[1]{
  \paragraph{\Glspl{#1}}
  \glsentrydesc{#1}.%
  \par%
}

\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcommand\cyclePic{
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
    \showGls{yonder}
  \or
    \null
    \showGls{sable}
  \or
    \pic{Irina/fury}
    \showGls{wrecan}
  \or
    \null
    \showGls{abderian}
  \or
    \pic{Irina/forest}
    \showGls{sylf}
  \or
    \pic{Irina/old_age}
    \showGls{eldren}
  \fi
}

% Check the date 15 days from now, so we can place the current cycle and next
% cycle on the front cover.
\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{15}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \ifnum\value{r3}=12
    \setcounter{r3}{1}
  \else
    \addtocounter{r3}{1}
  \fi
\fi

\begin{document}

\frontmatter
\setCycle{\month}{\day}

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Gls{gmt} \arabic{fenestraYear} \showCycle, day \arabic{fenestraDay}
  }
  \par
  \ifcase\value{cycle}
    \vspace{-4em}
  \or%
  \or%
  \or%
  \or%
      \vspace{-4em}%
  \else%
      \vspace{-3em}%
  \fi%
  \makebox(0,0)[t]{
    \ifcase\value{cycle}%
      \hspace{-9em}%
    \or%
      \hspace{-1em}%
    \or%
      \hspace{1em}%
    \or%
      \hspace{3em}%
    \else%
      \hspace{0.5em}%
    \fi%
    \orrery[\month/\day, \value{r3}/\value{r3b}]
  }
}

\setcounter{track}{\thecycle}%
\stepcounter{track}%

\noindent
The black dot on the cover represents \gls{fenestra}.
This is
\gls{cycle}~\Roman{track}, when \gls{fenestra}
\ifcase\thecycle%
  circles behind the \gls{ainumar}, and cooling rapidly.
\or%
  moves behind the \gls{ainumar}, away from the Sun.
  \ifnum\thefenestraDay<4%
    \Gls{snow} is about to fall.
  \else%
    A blanket of \gls{snow} covers everything.
  \fi%
\or%
  circles its planet, and heads closer to the Sun.
\or%
  approaches the Sun, and heats up rapidly.
\or%
  passes between the Sun and the \gls{ainumar}, and every night turns to face the bright \gls{ainumar} reflecting the Sunlight.
\else%
  cools down, as it moves away from the Sun, at the end of the year.
\fi%
Today is day \thefenestraDay, and these are the days ahead.

Days with a `\A' symbol show an encounter.
Select the next encounter \vpageref{encI}.

\foreach \d in {1,...,28}%
  {
  \ifnum\thefenestraDay=1%
    \IfLabelExistsTF{wrathSection}{%
      \vspace{\baselineskip}
      \noindent%
      `\glsentrysymbol{grummel}' indicates \pgls{storm}, \vpageref{wrathSection}.
    }{}
    \IfLabelExistsTF{encII}{%
      \vspace{1\baselineskip}
      \needspace{5\baselineskip}%
      \noindent%
      \bfseries\showCycle\mdseries:
      encounters listed \vpageref{encII}.%
      \par%
    }{}
  \fi%
  \noindent
  \thefenestraDay.~%
  \ifnum\thefenestraDay>57%
    \glsentrysymbol{grummel} %
  \else%
    \noteEncounter%
  \fi\par%
  \advanceTheDate[1]%
  }

\pagestyle{minizine}

\setCycle{\month}{\day}

\clearpage

\subsection*{\showCycle}%
\showCycle
\label{encI}
\cycleDesc.

\cyclePic

\setcounter{segNo}{\month}

\foreach \d in {1,...,27}%
  {%
    \advanceTheDate[1]%
    \stepcounter{almatrack}%
    \ifnum\thefenestraDay>57%
      \ifnum\thefenestraDay=58%
        \needspace{5\baselineskip}%
        \subsection{\Glsfmtname{storm}}
        \label{wrathSection}%
      \fi%
        \wrath%
      \addtocounter{almatrack}{-1}%
    \else%
      \ifnum\thefenestraDay=1%
        \par%
        \subsection*{\showCycle}%
        \showCycle%
        \label{encII}
        \cycleDesc.\par%
        \cyclePic%
        \par%
      \fi%
      \ifnum\thealmatrack>4%
        \addtocounter{almatrack}{-5}%
        \IfFileExists{encounters/enc_\thecycle_\thesegNo.tex}{}%
          { \setcounter{segNo}{1}  }
        \bigLine\par\noindent%
        \input{encounters/enc_\thecycle_\thesegNo.tex}%
        \par%
        \addtocounter{segNo}{\value{r2c}}%
      \fi%
    \fi%
  }

\subsection{\Glsfmtname{bothy} \& \Glsfmtname{broch}}

\input{encounters/broch_\arabic{r2}.tex}

\input{encounters/bothy_\arabic{r3}.tex}

\ifnum\thepage<12
  \input{encounters/bothy_\arabic{r3}.tex}
\fi

\pagebreak

\subsection{Glossary}

\ifnum\thepage<13
  \showGls{bothy}
  \showGls{broch}
\fi

{
  % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
  \toggletrue{intro}
  \showGls{harvesting}
}

  \IfLabelExistsTF{\jobname:harvestBasilisk}{
    \showGls{basilisk}
  }{}

  \IfLabelExistsTF{\jobname:harvestGriffin}{
    \showGls{griffin}
  }{}

  \IfLabelExistsTF{\jobname:harvestMshrooms}{
    \showGls{marchingMushroom}
  }{}

  \IfLabelExistsTF{\jobname:harvestDigger}{
    \showGls{digger}
  }{}

  \IfLabelExistsTF{\jobname:harvestCrawler}{
    \showGls{crawler}
  }{}

  \IfLabelExistsTF{\jobname:harvestWoodspy}{
    \showGls{woodspy}
  }{}

\ifnum\thepage<14
  \clearpage
\fi

\end{document}
