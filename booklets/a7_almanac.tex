\documentclass[10pt,twoside]{book}
\usepackage{config/bind}
\usepackage{config/booklet}
\setcounter{bookLevel}{2}
\externalReferent{core}
\externalReferent{stories}
\externalReferent{judgement}
\newcounter{almatrack}
\setcounter{almatrack}{0}
\newcounter{randomEncounter}
\setcounter{tn}{0}
\setcounter{segNo}{\value{r3}}

\newcommand\stateCycle{%
  \ifcase\thecycle%
    \gls{cOne}%
  \or%
    \gls{cTwo}%
  \or%
    \gls{cThree}%
  \or%
    \gls{cFour}%
  \or%
    \gls{cFive}%
  \else%
    \gls{cSix}%
  \fi%
}

\newcommand\encounterList{
  \ifnum\thefenestraDay<57
    \needspace{9\baselineskip}
    \subsection*{Encounters in \showCycle}
    \setcounter{randomEncounter}{0}%
  \fi
}

\newcommand\wrath[1]{%
  \label{storm}%
  \ifnum\thefenestraDay=58%
    \Gls{storm} begins with \pgls{#1}%
  \else%
    \Gls{#1}%
  \fi%
}

% Does the day have an encounter?  If so, mark it with the '\A' symbol for
% 'animal' (encounter).  The macro rolls 6 + temperature against 2D6, and
% success brings the encounter.
% 
% We want at least 6 encounters, so each failure increases the counter 'tn'. 
% This counter starts at -22, and if it ever goes above 0 then it gets added to
% the 'roll'.
\newcommand\noteEncounter{%
  \randomize%
  \randomize%
  \randomize%
  \setcounter{enc}{6}%
  \addtocounter{enc}{\thetemperature}%
  \ifnum\thefenestraDay>57%
    \glsentrysymbol{grummel} %
    \ifnum\thefenestraDay=58%
      \setcounter{tn}{0}%
      \ifcase\thetemperature%
        \wrath{coldSnap}.
      \or%
        \wrath{flood}.
      \else%
        \ifnum\thecycle<4%
          \wrath{heatwave}.
        \else%
          \wrath{hurricane}.
        \fi%
      \fi%
    \else%
      \ifodd\thefenestraDay%
        \wrath{flood}.
      \else%
        \wrath{landslide} across nearby mountains.
      \fi%
    \fi%
  \else%
    \ifnum\thetn>0%
      \addtocounter{enc}{\thetn}%
    \else%
    \fi%
    \ifnum\theenc>\value{r12}%
      \ifnum\thetn>-18%
        \stepcounter{rn1t2}%
        \A~\showInterval{\value{rn1t2}}%
        \addtocounter{tn}{-4}%
      \else%
        \setcounter{tn}{0}%
      \fi%
    \else%
      \addtocounter{tn}{1}%
    \fi%
  \fi%
}

\newcommand\addEclipes[1][]{%
  \Gls{eclipse}#1%
}


\newcommand\checkEclipse{%
  \ifcase\thecycle%
    \ifnum\thefenestraDay=2%
      \addEclipes
    \fi%
  \or%
    \ifnum\thefenestraDay=29%
      \addEclipes[ (lasts 15 hours)]
    \fi%
  \or%
    \ifnum\thefenestraDay=57%
      \addEclipes
    \fi%
  \or%
    \ifnum\thefenestraDay=60%
      \addEclipes
    \fi%
  \or%
    \ifnum\thefenestraDay=60%
      \addEclipes
    \fi%
  \else%
  \fi%
}%

\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcommand\cyclePic{
  \par%
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
    \showGls{yonder}
  \or
    \null
    \showGls{sable}
  \or
    \pic{Irina/fury}
    \showGls{wrecan}
  \or
    \null
    \showGls{abderian}
  \or
    \pic{Irina/forest}
    \showGls{sylf}
  \or
    \pic{Irina/old_age}
    \showGls{eldren}
  \fi
}

% Check the date 15 days from now, so we can place the current cycle and next
% cycle on the front cover.
\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{15}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \ifnum\value{r3}=12
    \setcounter{r3}{1}
  \else
    \addtocounter{r3}{1}
  \fi
\fi

\begin{document}

\frontmatter
\setCycle{\month}{\day}

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Glsfmttext{gmt} \arabic{fenestraYear}, \showCycle, day \arabic{fenestraDay}
  }
  \par
  \ifcase\value{cycle}
    \vspace{-4em}
  \or%
  \or%
  \or%
  \or%
      \vspace{-4em}%
  \else%
      \vspace{-3em}%
  \fi%
  \makebox(0,0)[t]{
    \ifcase\value{cycle}%
      \hspace{-9em}%
    \or%
      \hspace{-1em}%
    \or%
      \hspace{1em}%
    \or%
      \hspace{3em}%
    \else%
      \hspace{0.5em}%
    \fi%
    \orrery[\month/\day, \value{r3}/\value{r3b}]
  }
}

\setcounter{track}{\thecycle}%
\stepcounter{track}%

\noindent%
The large circle on the cover is a Sun.
The \gls{ainumar} is a massive planet, with a raging storm on its face.
The black dot is \gls{fenestra} --- a moon, slightly smaller than Earth.

\sidebox[4]{
  \vspace{-1\baselineskip}
  \scriptsize
  \begin{nametable}{Legend}
    \A & Encounter at\ldots \\
    \gls{morning} & \glsentrydesc{morning} \\
    \gls{afternoon} & \glsentrydesc{afternoon} \\
    \gls{evening} & \glsentrydesc{evening} \\
    \gls{night} & \glsentrydesc{night} \\
    \IfLabelExistsTF{storm}{\glssymbol{storm} & \glsfmtname{storm} \\}{}
  \end{nametable}
}%
Today is \gls{cycle}~\Roman{track} (known as `\stateCycle'), when \gls{fenestra}
\ifcase\thecycle%
  cools down as it begins its journey to the dark behind the \gls{ainumar}, away from the Sun.
\or%
  moves behind the \gls{ainumar}, away from the Sun.
  \ifnum\thefenestraDay<4%
    \Gls{snow} is about to fall.
  \else%
    A blanket of \gls{snow} covers everything.
  \fi%
\or%
  circles its planet, and heads closer to the Sun.
\or%
  approaches the Sun, and heats up rapidly.
\or%
  passes between the Sun and the \gls{ainumar}, and every night turns to face the bright \gls{ainumar} reflecting the Sunlight.
\else%
  cools down, as it moves away from the Sun, at the end of the year.
\fi%
Today is day \thefenestraDay, and these are the days ahead.
Whenever a day has an encounter, select the next \vpageref{encI}.

\medskip

\foreach \d in {1,...,28}%
  {%
    \stepDate%
    \ifnum\thefenestraDay=1%
      \ifnum\thealmatrack>4%
        \addtocounter{almatrack}{-2}%
      \fi%
    \vspace{1\baselineskip}\noindent
    A new \gls{cycle} begins.
    Use the encounters for \stateCycle\ \vpageref{encII}.
    \gappto{\encounterList}{%
      \advanceTheDate[60]
      \subsection*{Encounters in \showCycle}
      The \gls{storm} settles.
      \ifodd\thecycle Sounds of \else Branches swing to a \fi\showTemperature\ wind through a crowded forest.
      \ifcase\thetemperature%%
        Snow falls gently.
        \ifodd\month%
          Traders shiver.
        \else%
          Footsteps crackle.
        \fi%
      \or%
        Birds chirp.
        Small, shrivelled leaves.
      \or%
        Wagon wheels squeak.
        The \gls{ainumar} shines bright throughout the night.
      \else%
        \ifodd\month%
          Insects buzz.
        \else%
          Bestial cacophony from the \gls{edge}.
        \fi%
        The engorged \gls{ainumar} lights the ground at night.
      \fi%
    }

  
    \gappto{\encounterList}{\label{encII}}
    \par
    \fi%
    \noindent
    \thefenestraDay.~%
    \ifnum\thefenestraDay=57%
      \ifnum\d>23%
        \breakforeach%
      \fi%
    \fi%
    \noteEncounter%
    \checkEclipse%
    \lightDots%
    \par%
    %%%%%%%%%%%
    \stepcounter{almatrack}%
    \ifnum\thealmatrack>3%
      \IfFileExists{encounters/enc_\thecycle_\thesegNo}{}{\setcounter{segNo}{1}}%
      \xappto{\encounterList}{\setcounter{segNoSpare}{\thesegNo}}
      \gappto{\encounterList}{%
        \par%
        \stepcounter{randomEncounter}%
        \bigLine\par
        \needspace{2\baselineskip}%
        \subsubsection{Encounter \therandomEncounter}%
        \input{encounters/enc_\thecycle_\thesegNoSpare.tex}%
      }%
      \stepcounter{segNo}%
      \setcounter{almatrack}{0}%
    \fi%
  }

\pagestyle{minizine}

\clearpage

\setCycle{\month}{\day}
\subsection{Cosmology}
\label{disasters}

\cyclePic

\foreach \term in {cOne,cTwo,cThree,cFour,cFive,cSix,eclipse,coldSnap,earthquake,flood,hurricane,storm,heatwave,landslide,grummel}%
  {
    \ifglsused{\term}{\showGls{\term}}{}
  }

\needspace{6\baselineskip}
\subsection{\Glsfmtname{monster}}

  \IfLabelExistsTF{\jobname:harvestBasilisk}{
    \showGls{basilisk}
  }{}

  \IfLabelExistsTF{\jobname:harvestGriffin}{
    \showGls{griffin}
  }{}

  \IfLabelExistsTF{\jobname:harvestMshrooms}{
    \showGls{marchingMushroom}
  }{}

  \IfLabelExistsTF{\jobname:harvestDigger}{
    \showGls{digger}
  }{}

  \IfLabelExistsTF{\jobname:harvestCrawler}{
    \showGls{crawler}
  }{}

  \IfLabelExistsTF{\jobname:harvestWoodspy}{
    \showGls{woodspy}
  }{}

{
  % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
  \toggletrue{intro}
  \showGls{harvesting}
}

\label{encI}
\encounterList

\setcounter{almatrack}{\value{r3}}

\ifnum\thepage>12%
  \clearpage
\fi

\ifnum\thepage<12%
  \subsection{Hearths at the \Glsfmttext{edge}}

  \stepcounter{almatrack}%
  \IfFileExists{encounters/broch_\thealmatrack.tex}{}{\setcounter{almatrack}{1}}%
  \input{encounters/broch_\thealmatrack.tex}
\else%
  \ifnum\thepage<13%
    \subsection{\Glsfmtname{bothy}}
    \IfFileExists{encounters/bothy_\thealmatrack.tex}{}{\setcounter{almatrack}{1}}%
    \input{encounters/bothy_\thealmatrack.tex}%
  \fi%
\fi%

\Repeat{2}{\ifnum\thepage<13%
  \stepcounter{almatrack}%
  \IfFileExists{encounters/bothy_\thealmatrack.tex}{}{\setcounter{almatrack}{1}}%
  \input{encounters/bothy_\thealmatrack.tex}%
\fi}

\ifnum\thepage<14
  \pagebreak\null
\fi

\end{document}
