\documentclass[10pt,twoside]{book}
\usepackage{config/bind}
\usepackage{config/booklet}
\setcounter{bookLevel}{2}
\externalReferent{core}
\externalReferent{stories}
\externalReferent{judgement}
\newcounter{almatrack}
\setcounter{almatrack}{0}
\newcounter{randomEncounter}
\setcounter{tn}{-22}

\newcommand\stateCycle{%
  \ifcase\thecycle%
    \gls{cOne}%
  \or%
    \gls{cTwo}%
  \or%
    \gls{cThree}%
  \or%
    \gls{cFour}%
  \or%
    \gls{cFive}%
  \else%
    \gls{cSix}%
  \fi%
}

\newcommand\encounterList{
  \ifnum\thefenestraDay<57
    \subsection*{Encounters in \showCycle}
    \setcounter{randomEncounter}{0}%
  \fi
}

\newcommand\wrath[1]{%
  \ifnum\thefenestraDay=58%
    \Gls{storm} begins with \pgls{#1}
  \else%
    \Gls{#1}
  \fi%
}

% Does the day have an encounter?  If so, mark it with the '\A' symbol for
% 'animal' (encounter).  The macro rolls 6 + temperature against 2D6, and
% success brings the encounter.
% 
% We want at least 6 encounters, so each failure increases the counter 'tn'. 
% This counter starts at -22, and if it ever goes above 0 then it gets added to
% the 'roll'.
\newcommand\noteEncounter{%
  \randomize%
  \randomize%
  \randomize%
  \setcounter{enc}{6}%
  \addtocounter{enc}{\thetemperature}%
  \ifnum\thefenestraDay>57%
    \glsentrysymbol{grummel} %
    \ifnum\thefenestraDay=58%
      \ifcase\thetemperature%
        \wrath{coldSnap}
      \or%
        \wrath{flood}
      \else%
        \ifnum\thecycle<4%
          \wrath{heatwave}%
        \else%
          \wrath{hurricane}%
        \fi%
      \fi%
    \else%
      \ifodd\thefenestraDay%
        \wrath{flood}%
      \else%
        \wrath{landslide}%
      \fi%
    \fi%
  \else%
    \ifnum\thetn>0%
      \addtocounter{enc}{\thetn}%
      \ifnum\thetn>4%
        \addtocounter{tn}{-5}%
      \fi%
    \fi%
    \ifnum\theenc>\value{r12}%
      \stepcounter{rn1t2}%
      \A~\showInterval{\value{rn1t2}}%
    \else%
      \stepcounter{tn}%
    \fi%
  \fi%
}

\newcommand\addEclipes[1][]{%
  \Gls{eclipse}#1%
}


\newcommand\checkEclipse{%
  \ifcase\thecycle%
    \ifnum\thefenestraDay=3%
      \addEclipes
    \fi%
  \or%
    \ifnum\thefenestraDay=30%
      \addEclipes[ (lasts 15 hours)]
    \fi%
  \or%
    \ifnum\thefenestraDay=57%
      \addEclipes
    \fi%
  \or%
  \or%
    \ifnum\thefenestraDay=1%
      \addEclipes
    \fi%
  \else%
    \ifnum\thefenestraDay=1%
      \addEclipes
    \fi%
  \fi%
}%

\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcommand\cyclePic{
  \par%
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
    \showGls{yonder}
  \or
    \null
    \showGls{sable}
  \or
    \pic{Irina/fury}
    \showGls{wrecan}
  \or
    \null
    \showGls{abderian}
  \or
    \pic{Irina/forest}
    \showGls{sylf}
  \or
    \pic{Irina/old_age}
    \showGls{eldren}
  \fi
}

% Check the date 15 days from now, so we can place the current cycle and next
% cycle on the front cover.
\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{15}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \ifnum\value{r3}=12
    \setcounter{r3}{1}
  \else
    \addtocounter{r3}{1}
  \fi
\fi

\begin{document}

\frontmatter
\setCycle{\month}{\day}

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Glsfmttext{gmt} \arabic{fenestraYear}, \showCycle, day \arabic{fenestraDay}
  }
  \par
  \ifcase\value{cycle}
    \vspace{-4em}
  \or%
  \or%
  \or%
  \or%
      \vspace{-4em}%
  \else%
      \vspace{-3em}%
  \fi%
  \makebox(0,0)[t]{
    \ifcase\value{cycle}%
      \hspace{-9em}%
    \or%
      \hspace{-1em}%
    \or%
      \hspace{1em}%
    \or%
      \hspace{3em}%
    \else%
      \hspace{0.5em}%
    \fi%
    \orrery[\month/\day, \value{r3}/\value{r3b}]
  }
}

\setcounter{track}{\thecycle}%
\stepcounter{track}%

\noindent
The black dot on the cover represents \gls{fenestra}.
This is
\gls{cycle}~\Roman{track} (known as `\stateCycle'), when \gls{fenestra}
\ifcase\thecycle%
  circles behind the \gls{ainumar}, and cooling rapidly.
\or%
  moves behind the \gls{ainumar}, away from the Sun.
  \ifnum\thefenestraDay<4%
    \Gls{snow} is about to fall.
  \else%
    A blanket of \gls{snow} covers everything.
  \fi%
\or%
  circles its planet, and heads closer to the Sun.
\or%
  approaches the Sun, and heats up rapidly.
\or%
  passes between the Sun and the \gls{ainumar}, and every night turns to face the bright \gls{ainumar} reflecting the Sunlight.
\else%
  cools down, as it moves away from the Sun, at the end of the year.
\fi%
Today is day \thefenestraDay, and these are the days ahead.

\vspace{2\baselineskip}

\foreach \d in {1,...,28}%
  {%
    \stepDate%
    \ifnum\thefenestraDay=1%
      \ifnum\thealmatrack>4%
        \addtocounter{almatrack}{-2}%
      \fi%
    \vspace{1\baselineskip}\noindent
    A new \gls{cycle} begins: \stateCycle.
    Use the encounters \vpageref{encII}.
    \gappto{\encounterList}{%
      \advanceTheDate[60]
      \subsection*{Encounters in \showCycle}
      The \gls{storm} settles, \showTemperature\ wind in the forest.
      \MakeUppercase{\expandafter}\
      \ifcase\thetemperature%%
        Snow falls gently.
        Traders shiver.
      \or%
        Birds chirp.
        Small, shrivelled leaves.
      \or%
        Wagon wheels squeak.
        The \gls{ainumar} shines bright throughout the night.
      \else%
        Insect buzz.
        The engorged \gls{ainumar} lights the ground at night.
      \fi%
    }

  
    \gappto{\encounterList}{\label{encII}}
    \par
    \fi%
    \noindent
    \thefenestraDay.~%
    \ifnum\thefenestraDay=57%
      \ifnum\d>23%
        \breakforeach%
      \fi%
    \fi%
    \noteEncounter%
    \checkEclipse%
    \lightDots%
    \par%
    %%%%%%%%%%%
    \stepcounter{almatrack}%
    \ifnum\thealmatrack>3%
      \IfFileExists{encounters/enc_\thecycle_\thesegNo}{}{\setcounter{segNo}{1}}%
      \xappto{\encounterList}{\setcounter{segNoSpare}{\thesegNo}}
      \gappto{\encounterList}{%
        \par%
        \stepcounter{randomEncounter}%
        \vspace{1\baselineskip}%
        \needspace{4\baselineskip}%
        \qquad{\scshape Encounter \therandomEncounter}%
        \quad\bigLine\par
        \input{encounters/enc_\thecycle_\thesegNoSpare.tex}%
      }%
      \stepcounter{segNo}%
      \setcounter{almatrack}{0}%
    \fi%
  }

\pagestyle{minizine}

\begin{nametable}{Legend}
  \A & Encounter at\ldots \\
  \gls{morning} & \glsentrydesc{morning} \\
  \gls{afternoon} & \glsentrydesc{afternoon} \\
  \gls{evening} & \glsentrydesc{evening} \\
  \gls{night} & \glsentrydesc{night} \\
  \ifglsused{storm}{\glssymbol{storm} & \glsfmtname{storm} \\}
  \hline
\end{nametable}

\clearpage

\subsection{Glossary}

  \showGls{bothy}
  \showGls{broch}

\setCycle{\month}{\day}
\subsection{Cosmology}
\label{disasters}

\cyclePic

\foreach \term in {cOne,cTwo,cThree,cFour,cFive,cSix,eclipse,coldSnap,earthquake,flood,hurricane,storm,heatwave,landslide,grummel}%
  {
    \ifglsused{\term}{\showGls{\term}}{}
  }

\needspace{6\baselineskip}
\subsection{\Glsfmtname{monster}}

  \IfLabelExistsTF{\jobname:harvestBasilisk}{
    \showGls{basilisk}
  }{}

  \IfLabelExistsTF{\jobname:harvestGriffin}{
    \showGls{griffin}
  }{}

  \IfLabelExistsTF{\jobname:harvestMshrooms}{
    \showGls{marchingMushroom}
  }{}

  \IfLabelExistsTF{\jobname:harvestDigger}{
    \showGls{digger}
  }{}

  \IfLabelExistsTF{\jobname:harvestCrawler}{
    \showGls{crawler}
  }{}

  \IfLabelExistsTF{\jobname:harvestWoodspy}{
    \showGls{woodspy}
  }{}

{
  % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
  \toggletrue{intro}
  \showGls{harvesting}
}

\label{encI}
\encounterList

\subsection{\Glsfmtname{bothy} \& \Glsfmtname{broch}}

\input{encounters/broch_\arabic{r2}.tex}

\ifnum\thepage<12
  \input{encounters/bothy_\arabic{r3}.tex}
\fi

\null
\ifnum\thepage<14
  \clearpage\null
\fi

\end{document}
