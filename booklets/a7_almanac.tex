\documentclass[10pt,twoside]{book}
\usepackage{config/bind}
\usepackage{config/booklet}
\setcounter{bookLevel}{2}
\externalReferent{core}
\externalReferent{stories}
\externalReferent{judgement}
\newcounter{almatrack}
\setcounter{almatrack}{0}
\setcounter{tn}{-22}

\newcommand\encounterList{
  \subsection{Encounters}
}

% Does the day have an encounter?  If so, mark it with the '\A' symbol for
% 'animal' (encounter).  The macro rolls 6 + temperature against 2D6, and
% success brings the encounter.
% 
% We want at least 6 encounters, so each failure increases the counter 'tn'. 
% This counter starts at -22, and if it ever goes above 0 then it gets added to
% the 'roll'.
\newcommand\noteEncounter{%
  \randomize%
  \randomize%
  \randomize%
  \ifnum\thefenestraDay=1%
    \xappto{\encounterList}{\setcounter{cycle}{\thecycle}}
    \gappto{\encounterList}{\cyclePic}%
  \fi%
  \setcounter{enc}{6}%
  \addtocounter{enc}{\thetemperature}%
  \ifnum\thefenestraDay>57%
    \glsentrysymbol{grummel} %
  \else%
    \ifnum\thetn>0%
      \addtocounter{enc}{\thetn}%
      \ifnum\thetn>4%
        \addtocounter{tn}{-5}%
      \fi%
    \fi%
    \ifnum\theenc>\value{r12}%
      \stepcounter{rn1t2}%
      \A~\showInterval{\value{rn1t2}}%
    \else%
      \stepcounter{tn}%
    \fi%
  \fi%
}


\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcommand\cyclePic{
  \par%
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
    \showGls{yonder}
  \or
    \null
    \showGls{sable}
  \or
    \pic{Irina/fury}
    \showGls{wrecan}
  \or
    \null
    \showGls{abderian}
  \or
    \pic{Irina/forest}
    \showGls{sylf}
  \or
    \pic{Irina/old_age}
    \showGls{eldren}
  \fi
}

% Check the date 15 days from now, so we can place the current cycle and next
% cycle on the front cover.
\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{15}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \ifnum\value{r3}=12
    \setcounter{r3}{1}
  \else
    \addtocounter{r3}{1}
  \fi
\fi

\begin{document}

\frontmatter
\setCycle{\month}{\day}

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Gls{gmt} \arabic{fenestraYear} \showCycle, day \arabic{fenestraDay}
  }
  \par
  \ifcase\value{cycle}
    \vspace{-4em}
  \or%
  \or%
  \or%
  \or%
      \vspace{-4em}%
  \else%
      \vspace{-3em}%
  \fi%
  \makebox(0,0)[t]{
    \ifcase\value{cycle}%
      \hspace{-9em}%
    \or%
      \hspace{-1em}%
    \or%
      \hspace{1em}%
    \or%
      \hspace{3em}%
    \else%
      \hspace{0.5em}%
    \fi%
    \orrery[\month/\day, \value{r3}/\value{r3b}]
  }
}

\setcounter{track}{\thecycle}%
\stepcounter{track}%

\noindent
The black dot on the cover represents \gls{fenestra}.
This is
\gls{cycle}~\Roman{track}, when \gls{fenestra}
\ifcase\thecycle%
  circles behind the \gls{ainumar}, and cooling rapidly.
\or%
  moves behind the \gls{ainumar}, away from the Sun.
  \ifnum\thefenestraDay<4%
    \Gls{snow} is about to fall.
  \else%
    A blanket of \gls{snow} covers everything.
  \fi%
\or%
  circles its planet, and heads closer to the Sun.
\or%
  approaches the Sun, and heats up rapidly.
\or%
  passes between the Sun and the \gls{ainumar}, and every night turns to face the bright \gls{ainumar} reflecting the Sunlight.
\else%
  cools down, as it moves away from the Sun, at the end of the year.
\fi%
Today is day \thefenestraDay, and these are the days ahead.

Days with a `\A' symbol show an encounter.
Select the next encounter \vpageref{encI}.

\foreach \d in {1,...,28}%
  {%
    \stepDate%
    \ifnum\thefenestraDay=1%
      \ifnum\thealmatrack>4%
        \addtocounter{almatrack}{-2}%
      \fi%
    \fi%
    \noindent
    \thefenestraDay.~%
      \ifnum\thefenestraDay=57%
        \ifnum\d>23%
          \breakforeach%
        \fi%
      \fi%
    \noteEncounter%
    \lightDots%
    \par%
    %%%%%%%%%%%
    \stepcounter{almatrack}%
    \ifnum\thealmatrack>3%
      \IfFileExists{encounters/enc_\thecycle_\thesegNo}{}{\setcounter{segNo}{1}}%
      \xappto{\encounterList}{\setcounter{segNoSpare}{\thesegNo}}
      \gappto{\encounterList}{%
        \input{encounters/enc_\thecycle_\thesegNoSpare.tex}%
      }%
      \stepcounter{segNo}%
      \setcounter{almatrack}{0}%
    \fi%
  }

\clearpage

\subsection{\Glsfmtname{bothy} \& \Glsfmtname{broch}}

\input{encounters/broch_\arabic{r2}.tex}

\encounterList

\ifnum\thepage<12
  \input{encounters/bothy_\arabic{r3}.tex}
\fi

\pagebreak

\ifnum\thepage<14
  \subsection{Glossary}

  \ifnum\thepage<13
    \showGls{bothy}
    \showGls{broch}
  \fi

  {
    % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
    \toggletrue{intro}
    \showGls{harvesting}
  }

    \IfLabelExistsTF{\jobname:harvestBasilisk}{
      \showGls{basilisk}
    }{}

    \IfLabelExistsTF{\jobname:harvestGriffin}{
      \showGls{griffin}
    }{}

    \IfLabelExistsTF{\jobname:harvestMshrooms}{
      \showGls{marchingMushroom}
    }{}

    \IfLabelExistsTF{\jobname:harvestDigger}{
      \showGls{digger}
    }{}

    \IfLabelExistsTF{\jobname:harvestCrawler}{
      \showGls{crawler}
    }{}

    \IfLabelExistsTF{\jobname:harvestWoodspy}{
      \showGls{woodspy}
    }{}

  \ifnum\thepage<14
    \clearpage
  \fi
\else
  \null
  \newpage
\fi

\end{document}
