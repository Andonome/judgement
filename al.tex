\documentclass[10pt,twoside]{book}

\usepackage{config/bind}
\usepackage{config/booklet}
\setcounter{bookLevel}{2}
\externalReferent{core}
\externalReferent{judgement}
\newcounter{almatrack}
\setcounter{almatrack}{60}
\addtocounter{almatrack}{-\thefenestraDay}
\divide\value{almatrack} by 4
\ifnum\thealmatrack>6
  \setcounter{almatrack}{6}
\fi

\newtoggle{wrath}
\togglefalse{wrath}
\newcommand\Wraths{}
\newcommand*\wrath{%
  Wrath! %
  \randomize%
  \global\toggletrue{wrath}%
  \ifcase\value{r4}\relax\or%
    \composeWrath{hurricane}
  \or%
    \composeWrath{earthquake}
  \or%
    \composeWrath{snow}
  \else%
    \composeWrath{flood}
  \fi%
  \stepcounter{track}
}

\newcommand\composeWrath[1]{
  \Glsfmtname{#1}
  (\vpageref{wrath:\thetrack})
  \gappto{\Wraths}{%
    \subsubsection{\glsfmtname{#1}}
    \label{wrath:\thetrack}
    \glsentrydesc{#1}.%
  }%
}

\newcommand\showEncounterFiles[2]{
  \foreach \n in {#1,...,#2}%
    {%
      \stepcounter{encnum}
      \IfFileExists{encounters/enc_\thecycle_\theencnum.tex}{%
        \subsubsection{Encounter \n}
        \input{encounters/enc_\thecycle_\theencnum.tex}
      }{ \setcounter{encnum}{1} \n,}
    }
}

%!
\newcommand\stepDay[1]{}

\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcommand\cyclePic{
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
  \or
    \null
  \or
    \pic{Irina/fury}
  \or
    \null
  \or
    \pic{Irina/forest}
  \or
    \pic{Irina/old_age}
  \fi
}

\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{14}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \ifnum\value{r3}=12
    \setcounter{r3}{1}
  \else
    \addtocounter{r3}{1}
  \fi
\fi

\begin{document}

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Gls{gmt} \arabic{fenestraYear} \showCycle, day \arabic{fenestraDay}
  }
  \par
  \ifcase\value{cycle}
    \vspace{-4em}
  \or%
  \or%
  \or%
  \or%
      \vspace{-3em}%
  \else%
  \fi%
  \makebox(0,0)[t]{
    \ifcase\value{cycle}%
      \hspace{-9em}%
    \or%
      \hspace{-1em}%
    \or%
      \hspace{1em}%
    \or%
      \hspace{3em}%
    \or%
      \hspace{3em}%
    \else%
      \hspace{-3em}%
    \fi%
    \orrery[\month/\day, \value{r3}/\value{r3b}]
  }
}

{
  \footnotesize
  \noindent
  \showCycle\
  \cycleDesc.
  \vspace{0.7em}
  {
    % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
    \toggletrue{intro}
    \showGls{harvesting}
  }
}

  \IfLabelExistsTF{\jobname:harvestBasilisk}{
    \showGls{basilisk}
  }{ \clearpage }

  \IfLabelExistsTF{\jobname:harvestGriffin}{
    \showGls{griffin}
  }{ \pagestyle{minizine} }

  \pagestyle{minizine}

  \IfLabelExistsTF{\jobname:harvestMshrooms}{
    \showGls{marchingMushroom}
  }{}

  \IfLabelExistsTF{\jobname:harvestDigger}{
    \showGls{digger}
  }{}

  \IfLabelExistsTF{\jobname:harvestCrawler}{
    \showGls{crawler}
  }{}

  \IfLabelExistsTF{\jobname:harvestWoodspy}{
    \showGls{woodspy}
  }{}

\clearpage

\griffin

\noindent
\textbf{\large\thefenestraYear: \showCycle}
\setcounter{track}{1}

Encounters \vpageref{encI}.

\foreach \d in {1,...,28}%
  {
  \advanceTheDate[1]%
  \ifnum\thefenestraDay=1%
    \textbf{\large\thefenestraYear: \showCycle}\par%
    Encounters \vpageref{encII}.%
    \par%
  \fi%
  \thefenestraDay.\qquad%
  \ifnum\thefenestraDay>57%
    \wrath\par%
  \else%
    \randomize%
    \ifodd\value{r3c}\else%
      Encounter!%
    \fi%
  \fi\par%
  }

\setCycle{\month}{\day}

\vspace{2\baselineskip}
\textbf{\scshape\large Encounters in \showCycle}
\label{encI}


\setcounter{encnum}{\day}

\showEncounterFiles{1}{\thealmatrack}

\iftoggle{wrath}{
  \textbf{\scshape\large \glsfmtname{storm}}
  \setcounter{track}{1}
  \Wraths
}{}

\iftoggle{wrath}{
  \advanceTheDate[28]
  \setcounter{track}{7}
  \addtocounter{track}{-\value{almatrack}}
  \setcounter{almatrack}{\thetrack}
  \textbf{\scshape\large Encounters in \showCycle}
  \label{encII}
  \showEncounterFiles{\thealmatrack}{7}
}{}

\end{document}
