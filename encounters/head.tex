\documentclass[10pt,twoside]{book}

\usepackage{config/bind}
\usepackage{config/booklet}
\externalReferent{core}
\externalReferent{judgement}


\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcounter{noEncounters}
\input{booklets/no_enc.tex}

\newcommand\stormEffect{%
  \randomize%
  \ifcase\value{r4}\relax%
  \or%
    \pgls{earthquake}.
    They \glsentrydesc{earthquake}%
  \or%
    \pgls{flood}.
    They can \glsentrydesc{flood}%
  \or%
    a lightning storm and fast winds%
  \else%
    \pgls{hurricane}.
    They \glsentrydesc{hurricane}%
  \fi%
}

\newcommand\cycleWrath{
    \subsubsection{\showCycle\ day 58}
    The \gls{storm} has begun with \stormEffect.

    \subsubsection{\showCycle\ day 59}
    The \gls{storm} continues with \stormEffect.

    \ifnum\thepage<14
      \subsubsection{\showCycle\ day 60}
      The \gls{storm} ends with \stormEffect.
      \ifnum\value{cycle}=5
        \par
        \Gls{cOne} begins with \pgls{eclipse}.
        At noon, \gls{yonder} decides to \glsentrydesc{eclipse}.
      \fi
    \fi
}

\newcommand\cyclePic{
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
  \or
    \relax
  \or
    \pic{Irina/fury}
  \or
    \relax
  \or
    \pic{Irina/forest}
  \or
    \pic{Irina/old_age}
  \fi
}


\newcommand\stepDay[1]{
  \ifnum\thepage>12
    \ifnum\thepage=13
      \pagebreak
      \cyclePic
    \fi
    \end{document}
  \fi
  \set{track}{fenestraDay}
  \addtocounter{track}{#1}
  \addtocounter{fenestraDay}{#1}
  \ifnum\value{track}>57
    \cycleWrath
    \setcounter{fenestraDay}{0}
    \addtocounter{fenestraDay}{#1}
    \stepcounter{cycle}
    \ifnum\value{cycle}>5
      \setcounter{cycle}{0}
      \stepcounter{fenestraYear}
    \fi
    \setTemperature
  \fi
  \Needspace{4\baselineskip}
  \vspace{1em}
  {\noindent\scshape\large\showCycle\ day \arabic{fenestraDay}\quad}
}

\begin{document}

\setcounter{r2}{\month}
\setcounter{r2b}{\day}
\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{16}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \addtocounter{r3}{1}
\fi

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Gls{gmt} \arabic{fenestraYear} \showCycle, day \arabic{fenestraDay}
  }
  \par
  \vspace{-4em}
  \makebox(0,0)[t]{
    \ifnum\value{cycle}<2%
      \hspace{-10em}%
    \fi%
    \orrery[\value{r2}/\value{r2b}, \value{r3}/\value{r3b}]
  }
}

{
  \footnotesize
  \noindent
  \showCycle\
  \cycleDesc
  \vspace{0.7em}
  {
    % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
    \toggletrue{intro}
    \showGls{harvesting}
  }
}

  \IfLabelExistsTF{\jobname:harvestBasilisk}{
    \showGls{basilisk}
  }{}

  \IfLabelExistsTF{\jobname:harvestGriffin}{
    \showGls{griffin}
  }{}

  \IfLabelExistsTF{\jobname:harvestMshrooms}{
    \showGls{marchingMushroom}
  }{}

  \IfLabelExistsTF{\jobname:harvestDigger}{
    \showGls{digger}
  }{}

\pagestyle{minizine}

  \IfLabelExistsTF{\jobname:harvestCrawler}{
    \showGls{crawler}
  }{}

  \IfLabelExistsTF{\jobname:harvestWoodspy}{
    \showGls{woodspy}
  }{}



\foreach \x in {\arabic{fenestraDay},...,\arabic{noEncounters}}%
  {
      \ifnum\thepage<13
        \IfFileExists{encounters/enc_\x.tex}{
          \input{encounters/enc_\x.tex}
        }{}
      \fi
  }

\ifnum\thepage<13
  \foreach \x in {1,...,\arabic{noEncounters}}%
    {
        \ifnum\thepage<13
          \input{encounters/enc_\x.tex}
        \fi
    }
\fi

\ifnum\thepage=13
  \clearpage
  \cyclePic
\fi

\end{document}
