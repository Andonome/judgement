\documentclass[10pt,twoside]{book}

\usepackage{config/bind}
\usepackage{config/booklet}
\setcounter{bookLevel}{2}
\externalReferent{core}
\externalReferent{judgement}


\tcbset{ornamented/.style={skin=ornamented,
  before={\begin{figure}[hb!]},
  after={\afterStatBlock\end{figure}},
  }
}

\togglefalse{genExamples}

\newcounter{noEncounters}
\input{booklets/no_enc.tex}

\newcommand\stormEffect{%
  \randomize%
  \ifcase\value{r4}\relax%
  \or%
    \pgls{earthquake}.
    They \glsentrydesc{earthquake}%
  \or%
    \pgls{flood}.
    They can \glsentrydesc{flood}%
  \or%
    a lightning storm and fast winds%
  \else%
    \ifglsused{hurricane}{%
      \pgls{hurricane}%
    }{
      \pgls{hurricane}.
      They \glsentrydesc{hurricane}%
    }%
  \fi%
}

\newcommand\startWrath{
  \randomize
  \ifnum\value{fenestraDay}=58
    \bigLine
    That night, \gls{storm} begins with \stormEffect.
  \else
    \stepDay{1}
    \Gls{storm} has begun with \stormEffect.
  \fi
  \stepDay{1}
  The \gls{storm} continues with \stormEffect.
  \ifnum\thepage<14
    \stepDay{1}
    The \gls{storm} ends with \stormEffect.
  \fi

  \setcounter{fenestraDay}{0}
  \stepcounter{cycle}
  \ifnum\value{cycle}>5
    \setcounter{cycle}{0}
    \stepcounter{fenestraYear}
  \fi
  \setTemperature
}

\newcommand\cyclePic{
  \ifcase\value{cycle}
    \pic{Irina/curiosity}
  \or
    \null
  \or
    \pic{Irina/fury}
  \or
    \null
  \or
    \pic{Irina/forest}
  \or
    \pic{Irina/old_age}
  \fi
}


\newcommand\stepDay[1]{
  % Each Cycle has 60 days.  If an encounter waits 6 days and the current day is
  % 30, then the encounter occurs on day 36.  However, if the current day is 56,
  % then the encounter cannot skip ahead to day 62.  Instead, the encounter
  % waits 2 days, and the wrath begins.
  % The wrath starts stormy effects on day 58, then 59, and day 60.  After that,
  % a new Cycle begins.
  \ifnum\value{fenestraDay}<53
    \addtocounter{fenestraDay}{#1}
  \else
    \ifnum\value{fenestraDay}>56
      \stepcounter{fenestraDay}
    \else
      \addtocounter{fenestraDay}{2}
    \fi
  \fi
  \Needspace{4\baselineskip}
  \vspace{1em}
  {\noindent\scshape\large\showCycle\ day \arabic{fenestraDay}\quad}
}

\begin{document}

\setcounter{r2}{\month}
\setcounter{r2b}{\day}
\setcounter{r3}{\month}
\setcounter{r3b}{\day}
\addtocounter{r3b}{16}
\ifnum\value{r3b}>30
  \addtocounter{r3b}{-30}
  \addtocounter{r3}{1}
\fi

\miniCover{Almanac}{
  {
    \scshape\flushright\nobreak
    \Gls{gmt} \arabic{fenestraYear} \showCycle, day \arabic{fenestraDay}
  }
  \par
  \ifnum\value{cycle}=0
    \vspace{-4em}
  \fi
  \makebox(0,0)[t]{
    \ifcase\value{cycle}%
      \hspace{-9em}%
    \or%
      \hspace{-1em}%
    \or%
      \hspace{1em}%
    \or%
      \hspace{3em}%
    \or%
      \hspace{3em}%
    \else%
      \hspace{-3em}%
    \fi%
    \orrery[\value{r2}/\value{r2b}, \value{r3}/\value{r3b}]
  }
}

{
  \footnotesize
  \noindent
  \showCycle\
  \cycleDesc.
  \vspace{0.7em}
  {
    % We just need this to show the summary TN in harvesting, not an explanation for each cycle.
    \toggletrue{intro}
    \showGls{harvesting}
  }
}

  \IfLabelExistsTF{\jobname:harvestBasilisk}{
    \showGls{basilisk}
  }{ \clearpage }

  \IfLabelExistsTF{\jobname:harvestGriffin}{
    \showGls{griffin}
  }{ \pagestyle{minizine} }

  \pagestyle{minizine}

  \IfLabelExistsTF{\jobname:harvestMshrooms}{
    \showGls{marchingMushroom}
  }{}

  \IfLabelExistsTF{\jobname:harvestDigger}{
    \showGls{digger}
  }{}

  \IfLabelExistsTF{\jobname:harvestCrawler}{
    \showGls{crawler}
  }{}

  \IfLabelExistsTF{\jobname:harvestWoodspy}{
    \showGls{woodspy}
  }{}

\clearpage

\foreach \x in {\arabic{fenestraDay},...,\arabic{noEncounters}}%
  {
      \ifnum\thepage<12
        \ifnum\value{fenestraDay}<58
          \IfFileExists{encounters/enc_\x.tex}{
            \input{encounters/enc_\x.tex}
          }{}
        \else
          \startWrath
        \fi
      \fi
  }

\ifnum\thepage<12
  \foreach \x in {1,...,\arabic{noEncounters}}%
    {
        \ifnum\thepage<13
          \ifnum\value{fenestraDay}<58
            \input{encounters/enc_\x.tex}
          \else
            \startWrath
          \fi
        \else
          \ifnum\thepage=13
            \null
            \needspace{10\baselineskip}
            \input{encounters/enc_\x.tex}
          \fi
        \fi
    }
\fi

\null

\ifnum\thepage<14
  \clearpage
  \cyclePic
  \null
\fi

\ifnum\thepage<14
  \clearpage
  \null
\fi

\end{document}
